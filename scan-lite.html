<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Taxi Info QR Lite – QR-code scannen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body { background: #f8fbff; font-family: 'SF Pro Display', 'Roboto', Arial, sans-serif; margin: 0; padding: 0; color: #202b38; }
    .container { max-width: 420px; margin: 32px auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(0,40,80,0.07); padding: 28px 18px 32px 18px; }
    img.logo { width: 80px; display:block; margin:0 auto 12px auto;}
    h1 { font-size: 1.2em; color: #0061a8; text-align: center; }
    button { width: 100%; background: linear-gradient(90deg, #008fe2 0%, #0061a8 100%); color: #fff; border: none; border-radius: 12px; font-size: 1.12em; font-weight: 600; padding: 13px 0; cursor: pointer; margin-bottom: 18px; }
    button:hover { background: linear-gradient(90deg, #0061a8 0%, #008fe2 100%); }
    video, canvas { margin: 0 auto; display: block; border-radius: 12px; box-shadow: 0 2px 12px #e0e8f0; border: 1.5px solid #eaf2fb; max-width: 100%; }
    .naam { font-size: 1.5em; font-weight: bold; margin: 16px 0 8px 0; color: #0061a8; text-align:center; }
    .block { background: #f6fafd; border-radius: 10px; margin: 12px 0; padding: 12px; font-size: 1.08em; }
    .label { font-weight: 600; color: #008fe2; margin-bottom: 2px; }
    .call-btn { display: block; width: 100%; background: #00c853; color: #fff; text-align: center; font-size: 1.25em; font-weight: bold; padding: 14px 0; border-radius: 10px; margin: 14px 0 8px 0; text-decoration: none; }
    .call-btn:hover { background: #009624; }
    .info { font-size: 0.98em; color: #5a6b7a; margin-top: 12px; margin-bottom: 0; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="Logo Mytylschool Roosendaal" class="logo">
    <h1>Taxi Info QR Lite – QR-code scannen</h1>
    <button onclick="startScan()">Start scannen</button>
    <video id="video" width="320" height="320" autoplay playsinline style="display:none"></video>
    <canvas id="scanCanvas" width="320" height="320" style="display:none"></canvas>
    <div id="result"></div>
    <div class="info">Scan de QR-code van een leerling om de belangrijkste informatie te tonen. Het crisisnummer is direct belbaar.</div>
  </div>
  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('scanCanvas');
    let ctx = canvas.getContext('2d');
    let scanning = false;
    function startScan() {
      document.getElementById('result').innerHTML = "";
      video.style.display = "block";
      scanning = true;
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
          video.srcObject = stream;
          video.play();
          requestAnimationFrame(tick);
        })
        .catch(function(err) {
          alert("Kan camera niet openen: " + err);
          scanning = false;
        });
    }
    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        try {
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            // Ontsleutel met vast wachtwoord
            const pw = "Mytylschool";
            const bytes = CryptoJS.AES.decrypt(code.data, pw);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            if (originalText) {
              showData(originalText);
            } else {
              document.getElementById('result').innerHTML = "<b>QR-code niet geldig of niet met deze app gemaakt.</b>";
            }
            scanning = false;
            video.srcObject.getTracks().forEach(track => track.stop());
            video.style.display = "none";
            return;
          }
        } catch (e) {}
      }
      if (scanning) requestAnimationFrame(tick);
    }
    function showData(json) {
      let data;
      try { data = JSON.parse(json); } catch { data = {}; }
      let html = '';
      if (data.n) html += `<div class="naam">${data.n}</div>`;
      if (data.c) html += `<a class="call-btn" href="tel:${data.c.replace(/[^0-9+]/g,'')}">Bel crisisnummer (${data.c})</a>`;
      if (data.h) html += `<div class="block"><div class="label">Handelen</div>${data.h}</div>`;
      document.getElementById('result').innerHTML = html;
    }
  </script>
</body>
</html>
